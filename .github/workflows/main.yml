name: Stock Analysis Bot

on:
  schedule:
    # 早上：改成 UTC 00:00 (台灣 08:00)
    # 這樣就算延遲 50 分鐘，也才 08:50，還在開盤前，且符合 Python 邏輯
    - cron: '0 0 * * *'
    
    # 下午：維持 UTC 06:00 (台灣 14:00) 或改成 05:30 (13:30) 
    # 下午通常比較沒差，因為收盤後資料都在
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write  # 重要：允許 Action 寫入檔案

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11' # 解決之前的版本報錯問題

    - name: Install dependencies
      run: |
        pip install yfinance mplfinance pandas requests

    - name: Run Python Script
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        python bot.py

    - name: Commit and Push Record
      run: |
        git config --global user.name "StockBot"
        git config --global user.email "bot@github.com"
        
        # 檢查檔案是否存在，存在才執行 git add
        if [ -f trading_journal.csv ]; then
          git add trading_journal.csv
          # 只有在有變動時才 Commit
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update record [skip ci]" && git push)
        else
          echo "⚠️ 本次執行未產生 CSV 檔，跳過存檔步驟。"
        fi
